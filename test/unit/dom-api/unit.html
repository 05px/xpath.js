<!DOCTYPE html>
<html att="val">
	<head>
		<title>JsUnit testing page</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		<!-- JsUnitClient driver -->
		<script type="text/javascript" src="../jsUnitClient.js"></script>

		<!-- Library -->
		<script type="text/javascript" src="../../../xpath2-dom.js"></script>

		<!-- Suite definition -->
		<script type="text/javascript">
			// Helper function
			function evaluateXPath(sXPath, vContext, nType) {
				return XPath2Evaluator.prototype.evaluate.call(vContext, sXPath, vContext, function(prefix) {if (prefix == "ns")return "my_ns";}, nType);
			}

			function evaluateXPathNumber(sXPath, vContext) {
				return evaluateXPath(sXPath, vContext, 1).numberValue;
			}

			function evaluateXPathString(sXPath, vContext) {
				return evaluateXPath(sXPath, vContext, 2).stringValue;
			}

			function evaluateXPathError(sXPath, vContext) {
				var value	= null,
					error	= null;
				try {
					value	= evaluateXPathSingle(sXPath, vContext);
				}
				catch (e) {
					error	= e.code;
				}
				return error;
			}

			// DOMParser shim
			if (!window.DOMParser) {
				window.DOMParser	= function(){};
				DOMParser.prototype.baseURI	= null;
				DOMParser.prototype.parseFromString	= function(sXml, sType) {
					var oDocument	= new ActiveXObject("Microsoft.XMLDOM");
					oDocument.async				= false;
					oDocument.validateOnParse	= false;
					oDocument.preserveWhiteSpace= true;
					oDocument.resolveExternals	= false;
					oDocument.loadXML(sXml);
					return oDocument;
				};
			}
			// XMLHttpRequest shim
			if (!window.XMLHttpRequest) {
				window.XMLHttpRequest	= function() {
					return new ActiveXObject("Microsoft.XMLHTTP");
				};
			}

			// Get XML document
			var request	= new XMLHttpRequest;
			request.open("GET", "data/test.xml?nocache=" + Math.random(), false);
			request.send();

			// XML Tests (created with DOMParser)
			var xml	= new DOMParser().parseFromString(request.responseText, "text/xml");
			// Kind Tests

			function testDOMParser_KindTest_Node() {
				assertEquals(19,
						evaluateXPathNumber('count(descendant-or-self::node())', xml));
			}

			function testDOMParser_KindTest_DocumentNode() {
				assertEquals(1,
						evaluateXPathNumber('count(descendant-or-self::document-node())', xml));
			}

			function testDOMParser_KindTest_Element() {
				assertEquals(5,
						evaluateXPathNumber('count(descendant-or-self::element())', xml));
			}

			function testDOMParser_KindTest_Attribute() {
				assertEquals(13,
						evaluateXPathNumber('count(descendant-or-self::*/attribute())', xml));
			}

			function testDOMParser_KindTest_ProcessingInstruction() {
				assertEquals(2,
						evaluateXPathNumber('count(descendant-or-self::processing-instruction())', xml));
			}

			function testDOMParser_KindTest_Comment() {
				assertEquals(2,
						evaluateXPathNumber('count(descendant-or-self::comment())', xml));
			}

			function testDOMParser_KindTest_Text() {
				assertEquals(4,
						evaluateXPathNumber('count(descendant-or-self::text()[normalize-space() ne ""])', xml));
			}

			// Name Tests
			function testDOMParser_NameTest_Element() {
				assertEquals(1,
						evaluateXPathNumber('count(descendant-or-self::ele)', xml));
			}

			function testDOMParser_NameTest_Element_LocalNameWC() {
				assertEquals(5,
						evaluateXPathNumber('count(descendant-or-self::*)', xml));
			}

			function testDOMParser_NameTest_ElementNS() {
				assertEquals(2,
						evaluateXPathNumber('count(descendant-or-self::ns:ele)', xml));
			}

			function testDOMParser_NameTest_ElementNS_LocalNameWC() {
				assertEquals(3,
						evaluateXPathNumber('count(descendant-or-self::ns:*)', xml));
			}

			function testDOMParser_NameTest_ElementNS_PrefixWC() {
				assertEquals(3,
						evaluateXPathNumber('count(descendant-or-self::*:ele)', xml));
			}

			//
			function testDOMParser_NameTest_Attribute() {
				assertEquals(3,
						evaluateXPathNumber('count(descendant-or-self::*/@att)', xml));
			}

			function testDOMParser_NameTest_Attribute_LocalNameWC() {
				assertEquals(13,
						evaluateXPathNumber('count(descendant-or-self::*/@*)', xml));
			}

			function testDOMParser_NameTest_AttributeNS() {
				assertEquals(2,
						evaluateXPathNumber('count(descendant-or-self::*/@ns:att)', xml));
			}

			function testDOMParser_NameTest_AttributeNS_LocalNameWC() {
				assertEquals(4,
						evaluateXPathNumber('count(descendant-or-self::*/@ns:*)', xml));
			}

			function testDOMParser_NameTest_AttributeNS_PrefixWC() {
				assertEquals(5,
						evaluateXPathNumber('count(descendant-or-self::*/@*:att)', xml));
			}

			// Misc
			function testDOMParser_BaseUri() {
				assertEquals("http://my_base/",
						evaluateXPathString('base-uri(descendant-or-self::*[2])', xml));
			}

			function testDOMParser_FunctionCall_Id() {
				assertEquals("id-root",
						evaluateXPathString('string(id("id-root")/@id)', xml));
			}

			// Atomize
			function testDOMParser_Atomize_DocumentNode() {
				assertTrue(
						evaluateXPathString('string(/)', xml).indexOf("text2") != -1);
			}

			function testDOMParser_Atomize_Element() {
				assertEquals(" cdata ",
						evaluateXPathString('string(//ns:ele[1])', xml));
			}

			function testDOMParser_Atomize_Attribute() {
				assertEquals("att-no_ns",
						evaluateXPathString('string(//ns:ele[1]/@att)', xml));
			}

			function testDOMParser_Atomize_ProcessingInstruction() {
				assertEquals('href="custom.url" ',
						evaluateXPathString('string(descendant-or-self::processing-instruction()[1])', xml));
			}

			function testDOMParser_Atomize_Comment() {
				assertEquals(" comment ",
						evaluateXPathString('string(descendant-or-self::comment()[1])', xml));
			}

			function testDOMParser_Atomize_Text() {
				assertEquals(" cdata ",
						evaluateXPathString('string(//ns:ele[1]/text())', xml));
			}

			// 'node' functions
			// name()
			function testDOMParser_Name_DocumentNode() {
				assertEquals('',
						evaluateXPathString('/name()', xml));
			}

			function testDOMParser_Name_Element() {
				assertEquals("ele",
						evaluateXPathString('//ns:ele[1]/name()', xml));
				assertEquals("ele",
						evaluateXPathString('descendant-or-self::*[2]/name()', xml));
				assertEquals("ele",
						evaluateXPathString('descendant-or-self::*[3]/name()', xml));
			}

			function testDOMParser_Name_Attribute() {
				assertEquals("my:att",
						evaluateXPathString('//ns:ele[1]/@ns:att/name()', xml));
				assertEquals("att",
						evaluateXPathString('//ns:ele[1]/@att/name()', xml));
			}

			function testDOMParser_Name_ProcessingInstruction() {
				assertEquals("custom",
						evaluateXPathString('descendant-or-self::processing-instruction()[1]/name()', xml));
			}

			function testDOMParser_Name_Comment() {
				assertEquals("",
						evaluateXPathString('descendant-or-self::comment()[1]/name()', xml));
			}

			function testDOMParser_Name_Text() {
				assertEquals("",
						evaluateXPathString('//ns:ele[1]/text()/name()', xml));
			}

			// local-name()
			function testDOMParser_LocalName_DocumentNode() {
				assertEquals('',
						evaluateXPathString('/local-name()', xml));
			}

			function testDOMParser_LocalName_Element() {
				assertEquals("ele",
						evaluateXPathString('//ns:ele[1]/local-name()', xml));
			}

			function testDOMParser_LocalName_Attribute() {
				assertEquals("att",
						evaluateXPathString('//ns:ele[1]/@ns:att/local-name()', xml));
			}

			function testDOMParser_LocalName_ProcessingInstruction() {
				assertEquals("",
						evaluateXPathString('descendant-or-self::processing-instruction()[1]/local-name()', xml));
			}

			function testDOMParser_LocalName_Comment() {
				assertEquals("",
						evaluateXPathString('descendant-or-self::comment()[1]/local-name()', xml));
			}

			function testDOMParser_LocalName_Text() {
				assertEquals("",
						evaluateXPathString('//ns:ele[1]/text()/local-name()', xml));
			}

			// namespace-uri()
			function testDOMParser_NamespaceURI_DocumentNode() {
				assertEquals('',
						evaluateXPathString('/namespace-uri()', xml));
			}

			function testDOMParser_NamespaceURI_Element() {
				assertEquals("my_ns",
						evaluateXPathString('//ns:ele[1]/namespace-uri()', xml));
				assertEquals("",
						evaluateXPathString('descendant-or-self::*[2]/namespace-uri()', xml));
				assertEquals("my_ns",
						evaluateXPathString('descendant-or-self::*[3]/namespace-uri()', xml));
			}

			function testDOMParser_NamespaceURI_Attribute() {
				assertEquals("my_ns",
						evaluateXPathString('//ns:ele[1]/@ns:att/namespace-uri()', xml));
				assertEquals("",
						evaluateXPathString('//ns:ele[1]/@att/namespace-uri()', xml));
			}

			function testDOMParser_NamespaceURI_ProcessingInstruction() {
				assertEquals("",
						evaluateXPathString('descendant-or-self::processing-instruction()[1]/namespace-uri()', xml));
			}

			function testDOMParser_NamespaceURI_Comment() {
				assertEquals("",
						evaluateXPathString('descendant-or-self::comment()[1]/namespace-uri()', xml));
			}

			function testDOMParser_NamespaceURI_Text() {
				assertEquals("",
						evaluateXPathString('//ns:ele[1]/text()/namespace-uri()', xml));
			}

			// 'accessor' functions
/*			// node-name()
			function testDOMParser_NodeName_DocumentNode() {
				assertEquals('',
						evaluateXPathString('/node-name()', xml));
			}

			function testDOMParser_NodeName_Element() {
				assertEquals("ele",
						evaluateXPathString('//ns:ele[1]/node-name()', xml));
			}

			function testDOMParser_NodeName_Attribute() {
				assertEquals("att",
						evaluateXPathString('//ns:ele[1]/@ns:att/node-name()', xml));
			}

			function testDOMParser_NodeName_ProcessingInstruction() {
				assertEquals("",
						evaluateXPathString('descendant-or-self::processing-instruction()[1]/node-name()', xml));
			}

			function testDOMParser_NodeName_Comment() {
				assertEquals("",
						evaluateXPathString('descendant-or-self::comment()[1]/node-name()', xml));
			}

			function testDOMParser_NodeName_Text() {
				assertEquals("",
						evaluateXPathString('//ns:ele[1]/text()/node-name()', xml));
			}*/

			// XML Tests (provided by XMLHttpRequest.responseXML)
			var xhr	= request.responseXML;
			// TODO: Duplicate from above

			// HTML Tests
			var html	= document;
			function testHTML_NameTest_Element() {
				assertEquals(2,
						evaluateXPathNumber('count(descendant-or-self::p)', html));
			}

			function testHTML_NameTest_Attribute() {
				assertEquals(2,
						evaluateXPathNumber('count(descendant-or-self::*/@att)', html));
			}

			// Misc
			function testHTML_FunctionCall_Id() {
				assertEquals("id-root",
						evaluateXPathString('string(id("id-root")/@id)', html));
			}

			// Atomize
			function testHTML_Atomize_DocumentNode() {
				assertTrue(
						evaluateXPathString('string(/)', html).indexOf("JsUnit testing page") != -1);
			}

			function testHTML_Atomize_Element() {
				assertEquals("some element",
						evaluateXPathString('string(id("id-element"))', html));
			}

			function testHTML_Atomize_Attribute() {
				assertEquals("some attribute",
						evaluateXPathString('string(id("id-attribute")/@attribute)', html));
			}

			function testHTML_Atomize_ProcessingInstruction() {

			}

			function testHTML_Atomize_Comment() {
				assertEquals("some comment",
						evaluateXPathString('string(id("id-comment")/child::comment())', html));
			}

			function testHTML_Atomize_Text() {
				assertEquals("some text",
						evaluateXPathString('string(id("id-text")/child::text())', html));
			}
		</script>
	</head>
	<body>
		<p>XPath2.js JsUnit unit page</p>
		<div id="id-root">
			<p att="val"></p>
			<div id="id-text">some text</div>
			<div id="id-comment"><!--some comment--></div>
			<div id="id-attribute" attribute="some attribute"></div>
			<div id="id-element">some element</div>
		</div>
	</body>
</html>